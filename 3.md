Add AKS Backup Policy, Instance, RBAC & Dedicated Snapshot Resource Group

Overview

This PR introduces full AKS cluster backup enablement using Azure Data Protection.

The implementation includes:

Backup Vault integration

4-hour recurring backup policy

Backup instance for AKS cluster

Dedicated snapshot resource group

Required RBAC assignments

AKS Backup Extension deployment

Configuration-driven design via conf.yaml

This implementation is fully environment-driven and does not rely on hardcoded values or AKS node resource group assumptions.

 Components Added
1️. Backup Policy (azurerm_data_protection_backup_policy_kubernetes_cluster)
Purpose

Defines backup frequency and retention behavior for AKS.

Configuration

Backup interval: Every 4 hours

Retention: 30 days

Timezone: UTC

Datastore type: OperationalStore

Behavior

The policy uses ISO8601 repeating intervals:

R/2025-01-01T00:00:00+00:00/PT4H

This ensures consistent 4-hour backups across environments.

2.  Backup Instance (azurerm_data_protection_backup_instance_kubernetes_cluster)
Purpose

Attaches the backup policy to the AKS cluster.

Configuration

Targets AKS cluster defined in conf.yaml

Enables:

cluster_scoped_resources_enabled = true

volume_snapshot_enabled = true

Protects:

All namespaces

All resource types

Persistent volumes

Cluster-scoped resources

Snapshot Location

Backups store disk snapshots in a dedicated snapshot resource group, defined per environment in conf.yaml.

3️. Dedicated Snapshot Resource Group
Purpose

Separates backup snapshots from:

AKS control plane RG

AKS node RG

Platform RG

Why This Design

This avoids:

Dependency on MC_* naming

Dependency on AKS node RG

Tight coupling to cluster module outputs

This enables:

Clean separation of concerns

Better cost visibility

Cleaner RBAC boundaries

Safer production operations

Snapshot RG is dynamically created per environment if defined in configuration.

4️. RBAC Assignments

The following RBAC bindings are implemented:

Vault MSI Permissions
Role	Scope	Purpose
Reader	AKS Cluster	Read cluster metadata
Disk Snapshot Contributor	Snapshot RG	Create/manage disk snapshots
Data Operator for Managed Disks	Snapshot RG	Manage disk-level operations
Storage Blob Data Contributor	Backup Storage	Write backup data
AKS Backup Extension Identity
Role	Scope
Storage Account Contributor	Backup Storage Account
Trusted Access Binding

Configured using:

Microsoft.DataProtection/backupVaults/backup-operator

This enables vault-to-cluster secure integration.

5️. Locals Refactor (backup_locals.tf)
Purpose

Centralizes configuration parsing from conf.yaml.

Responsibilities

Builds local.backup_instances map


No hardcoding

Fully environment-driven configuration
