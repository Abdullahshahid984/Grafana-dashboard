# Add AKS Backup Policy, Instance, RBAC & Dedicated Snapshot Resource Group

## Overview

This PR introduces full AKS cluster backup enablement using **Azure Data Protection**.

The implementation includes:

- Backup Vault integration  
- 4-hour recurring backup policy  
- Backup instance for AKS cluster  
- Dedicated snapshot resource group  
- Required RBAC assignments  
- Configuration-driven design via `conf.yaml`  


---

# Components Added

---

## 1. Backup Policy  
**Resource:** `azurerm_data_protection_backup_policy_kubernetes_cluster`

### Purpose

Defines backup frequency and retention behavior for AKS.

### Configuration

- **Backup interval:** Every 4 hours  
- **Retention:** 30 days  
- **Timezone:** UTC  
- **Datastore type:** OperationalStore  

### Behavior

The policy uses ISO8601 repeating intervals:

```

R/2025-01-01T00:00:00+00:00/PT4H

````

This ensures consistent 4-hour backups across environments.

---

## 2. Backup Instance  
**Resource:** `azurerm_data_protection_backup_instance_kubernetes_cluster`

### Purpose

Attaches the backup policy to the AKS cluster.

### Configuration

Targets AKS cluster defined in `conf.yaml`.

Enables:

```hcl
    full_cluster_backup: true
````

### Protects

* All namespaces
* All resource types
* Persistent volumes
* Cluster-scoped resources

### Snapshot Location

Backups store disk snapshots in a dedicated snapshot resource group, defined per environment in `conf.yaml`.

---

## 3. Dedicated Snapshot Resource Group

### Purpose

Separates backup snapshots from:

* AKS control plane resource group
* AKS node resource group
* Platform resource group

### Why This Design

This avoids:

* Dependency on `MC_*` naming
* Dependency on AKS node RG
* Tight coupling to cluster module outputs

This enables:

* Clean separation of concerns
* Better cost visibility
* Cleaner RBAC boundaries
* Safer production operations

The Snapshot Resource Group is dynamically created per environment if defined in configuration.

---

## 4. RBAC Assignments

The following RBAC bindings are implemented:

| Identity                      | Role                            | Scope                  | Purpose                      |
| ----------------------------- | ------------------------------- | ---------------------- | ---------------------------- |
| Vault MSI                     | Reader                          | AKS Cluster            | Read cluster metadata        |
| Vault MSI                     | Disk Snapshot Contributor       | Snapshot RG            | Create/manage disk snapshots |
| Vault MSI                     | Data Operator for Managed Disks | Snapshot RG            | Manage disk-level operations |
| Vault MSI                     | Storage Blob Data Contributor   | Backup Storage         | Write backup data            |
| AKS Backup Extension Identity | Storage Account Contributor     | Backup Storage Account | Trusted access binding       |

### Trusted Access Binding

Configured using:

```
Microsoft.DataProtection/backupVaults/backup-operator
```

This enables vault-to-cluster secure integration.

---

## 5. Locals Refactor (`backup_locals.tf`)

### Purpose

Centralizes configuration parsing from `conf.yaml`.

### Responsibilities

* Builds `local.backup_instances` map
* No hardcoding
* Fully environment-driven configuration

---

# Design Principles

* Environment-driven configuration
* Clean separation of backup responsibilities
* Production-grade RBAC boundaries
* Terraform-native modular design

---

# Result

This implementation enables:

* Automated 4-hour AKS backups
* 30-day retention
* Secure vault integration
* Snapshot isolation
* Environment-specific configuration

- Or create a **README.md with usage instructions**
