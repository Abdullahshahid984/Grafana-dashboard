AKS Backup Implementation – Root Module Only
Terraform Implementation Requirement
AKS Backup Policy & Backup Instance Deployment
1. Current State

The following Azure resources are already provisioned via Terraform in the root module:

Azure Storage Account

Blob Container

Azure Data Protection Backup Vault

AKS Cluster

AKS Backup Extension

Snapshot Resource Group

No child modules are used.
All new resources must be defined in the root module.

2. Objective

Deploy and configure:

AKS Backup Policy

AKS Backup Instance

The implementation must provide full-cluster protection using:

Operational Tier backups

Backup frequency: every 4 hours

Retention: 30 days

Full namespace and cluster-scoped coverage

Persistent volume snapshots enabled

No exclusions must be configured.

3. Backup Policy Requirements
Setting	Value
Storage Tier	Operational
Backup Interval	PT4H
Retention	P30D
Time Zone	UTC
Cluster Scoped Support	Enabled
Volume Snapshot	Enabled

Expected Behavior:

Backups run every 4 hours

Data retained for 30 days

Compatible with namespaced + cluster-scoped resources

4. Backup Instance Requirements

The Backup Instance must:

Protect entire AKS cluster

Bind to created Backup Vault

Use Snapshot Resource Group

Bind to defined Backup Policy

Enable volume snapshot capability

Enable cluster-scoped resource protection

Include all Secrets

Include all namespaces

Include all resource types

Configuration Expectations
excluded_namespaces              = []
excluded_resource_types          = []
included_namespaces              = ["*"]
included_resource_types          = ["*"]
label_selectors                  = []
cluster_scoped_resources_enabled = true
volume_snapshot_enabled          = true
Protection Scope

All namespaces

All resource types (including Secrets)

All cluster-scoped objects (CRDs, ClusterRoles, ClusterRoleBindings)

All Persistent Volumes via Azure Disk snapshots

5. Security & RBAC Requirements
5.1 Trusted Access Binding

Bind Backup Vault to AKS cluster:

Role: Microsoft.DataProtection/backupVaults/backup-operator

Source: Backup Vault

Target: AKS Cluster

Purpose:
Allow Backup Vault to operate on AKS cluster.

5.2 AKS Backup Extension Permissions

Grant extension identity:

Role: Storage Account Contributor

Scope: Storage Account

Purpose:
Allow extension to write backup metadata and operational data.

5.3 Backup Vault Managed Identity Permissions
On AKS Cluster

Reader

On Snapshot Resource Group

Reader

Disk Snapshot Contributor

Data Operator for Managed Disks

On Storage Account

Storage Blob Data Contributor

Purpose:

Read cluster metadata

Create and manage disk snapshots

Write backup data to blob storage

5.4 AKS Cluster Managed Identity Permission

On Snapshot Resource Group:

Contributor

Purpose:
Allow AKS to manage snapshot lifecycle during backup operations.

6. Updated Architecture Schema
AKS Cluster
   │
   │ Trusted Access Binding
   ▼
Backup Vault (Azure Data Protection)
   │
   │ Uses
   ▼
Backup Policy (Operational Tier – PT4H – P30D)
   │
   ▼
Backup Instance
   │
   ├── Protects all namespaces
   ├── Protects cluster-scoped resources
   ├── Includes all Secrets
   └── Triggers Volume Snapshots
            │
            ▼
Snapshot Resource Group
            │
            ▼
Azure Disk Snapshots

Backup Data
   │
   ▼
Storage Account (Blob Container)
7. Updated poc-conf.yaml
environment: poc

aks_backup:
  enabled: true

  policy:
    name: aks-operational-4h-policy
    storage_tier: operational
    backup_interval: PT4H
    retention: P30D
    time_zone: UTC

  backup_instance:
    protect_cluster: true
    snapshot_resource_group: snap-rg
    include:
      namespaces: ["*"]
      resource_types: ["*"]
      cluster_scoped_resources: true
      secrets: true
      persistent_volumes: true
    exclude:
      namespaces: []
      resource_types: []
    label_selectors: []

rbac:
  trusted_access:
    role: Microsoft.DataProtection/backupVaults/backup-operator

  extension_permissions:
    storage_role: Storage Account Contributor

  vault_permissions:
    cluster_role: Reader
    snapshot_rg_roles:
      - Reader
      - Disk Snapshot Contributor
      - Data Operator for Managed Disks
    storage_role: Storage Blob Data Contributor

  cluster_permissions:
    snapshot_rg_role: Contributor
8. Implementation Constraints

Root module only

No child modules

No dynamic logic

No conditional resources

Explicit depends_on where required

Production-ready naming

No exclusions

Full cluster protection enabled

9. Expected Final Outcome

After terraform apply:

Backups run every 4 hours

All namespaces protected

All Secrets included

All cluster-scoped resources protected

Persistent volumes snapshotted

Operational tier used

30-day retention applied

RBAC fully configured

Trusted access properly bound

No partial protection

No exclusions
